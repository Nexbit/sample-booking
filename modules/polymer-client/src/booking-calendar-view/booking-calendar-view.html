<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../booking-events-calendar/booking-events-calendar.html">
<link rel="import" href="../../bower_components/cuba-data/cuba-entity.html">
<link rel="import" href="../../bower_components/cuba-data/cuba-service.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/datetime-picker/datetime-picker.html">

<dom-module id="booking-calendar-view">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }

      booking-events-calendar {
        height: 32em;
      }

      h3 {
        opacity: 0.7;
      }

      paper-input {
        width: 21em;
      }

      .booking-time {
        display: flex;
        align-items: center;
      }

      .booking-time.margin-bottom {
        margin-bottom: 0.5em;
      }

      .booking-time span {
        width: 100%;
      }

      .booking-time datetime-picker {
        flex: 1;
      }

      datetime-picker {
        --input-picker-color: var(--primary-text-color);
        --input-picker-background: var(--primary-background-color);
      }

      .card-actions {
        text-align: right;
      }
    </style>

    <cuba-entity id="resourceData"
                 entity-name="booking$Resource"
                 entity-id="[[_resourceId]]"
                 view="resource-view"
                 auto="false"
                 data="{{_resource}}">
    </cuba-entity>

    <cuba-service id="bookingsData"
                  service-name="booking_BookingsLoadService"
                  method="load"
                  auto="false"
                  params="[[_getServiceParams(_resource)]]">
    </cuba-service>

    <h3>[[_resource.name]]</h3>

    <booking-events-calendar id="eventCalendar"
                             events="[[_getBookings(_idsToBookings)]]">
    </booking-events-calendar>

    <paper-dialog id="editBookingDialog">
      <h2>[[_dialogCaption]]</h2>

      <paper-input value="{{_booking.title}}"
                   label="[[msg('booking$Booking.title')]]"
                   readonly$="[[!_editAllowed]]"
                   required>
      </paper-input>

      <div class="booking-time margin-bottom">
        <span>
          [[msg('booking$Booking.start')]]
        </span>
        <datetime-picker id="eventStartPicker"
                         value="{{_eventStart}}">
        </datetime-picker>
      </div>

      <div class="booking-time">
        <span>
          [[msg('booking$Booking.end')]]
        </span>
        <datetime-picker id="eventEndPicker"
                         value="{{_eventEnd}}">
        </datetime-picker>
      </div>

      <paper-input value="{{_booking.owner.name}}"
                   label="[[msg('booking$Booking.owner')]]"
                   readonly$="[[!_editAllowed]]"
                   hidden$="[[_editAllowed]]">
      </paper-input>

      <div class="card-actions">
        <paper-button on-tap="_delete"
                      hidden$="[[!_deleteAllowed]]">
          [[msg('Delete')]]
        </paper-button>
        <paper-button on-tap="_cancel">
          [[msg('Cancel')]]
        </paper-button>
        <paper-button on-tap="_save"
                      hidden$="[[!_editAllowed]]">
          [[msg('Save')]]
        </paper-button>
      </div>
    </paper-dialog>

    <paper-toast id="wrongBookingRange"
                 horizontal-align="right">
      Booking should have correct range
    </paper-toast>
  </template>
  <script>
    {
      class BookingCalendarView extends Polymer.mixinBehaviors([CubaLocalizeBehavior], Polymer.Element) {
        static get is() {
          return 'booking-calendar-view';
        }

        static get properties() {
          return {
            _resourceId: {
              type: String,
              computed: '_getResourceId(route)',
              observer: '_resourceIdChanged'
            },

            _resource: {
              type: Object,
              observer: '_resourceChanged',
              value: function () {
                return null;
              }
            },

            // fake id -> booking entity
            _idsToBookings: {
              type: Object
            },

            _fakeToRealIds: {
              type: Object
            },

            _booking: {
              type: Object
            },

            _loggedUser: {
              type: Object,
              value: function () {
                return null;
              }
            },

            // the following two properties are used to avoid affecting event ranges
            // when datetime picker popup is canceled
            _eventStart: {
              type: Date,
              computed: '_getEventStart(_booking)'
            },
            _eventEnd: {
              type: Date,
              computed: '_getEventEnd(_booking)'
            },

            _editAllowed: {
              type: Boolean,
              computed: '_getEditAllowed(_booking)'
            },

            _deleteAllowed: {
              type: Boolean,
              computed: '_getDeleteAllowed(_booking)'
            },

            _dialogCaption: {
              type: String,
              computed: '_getDialogCaption(_booking)'
            }
          }
        }

        ready() {
          super.ready();

          this.app.getUserInfo().then(function (userInfo) {
            this.set('_loggedUser', userInfo);
          }.bind(this));

          this.$.eventCalendar.addEventListener('event-click', event => this._eventClicked(event));
          this.$.eventCalendar.addEventListener('event-created', event => this._eventCreated(event));
          this.$.eventCalendar.addEventListener('event-resized', event => this._eventResized(event));

          this.$.eventCalendar.set('isEventResizable', (calEvent) => this._canResizeEvent(calEvent));
          this.$.eventCalendar.set('isLegalEvent', (calEvent) => calEvent.start >= new Date());

          this.$.editBookingDialog.addEventListener('iron-overlay-canceled', () => {
            this._booking = null;
          });
        }

        _getResourceId(route) {
          if (route && route.prefix && route.prefix.includes('booking-calendar-view')) {
            return route.path.substring(1);
          }
          return '';
        }

        _getEventStart(booking) {
          return booking ? booking.start : null;
        }

        _getEventEnd(booking) {
          return booking ? booking.end : null;
        }

        _getEditAllowed(booking) {
          return booking && booking.owner && booking.owner.login === this._loggedUser.login
            && booking.start > new Date();
        }

        _getDeleteAllowed(booking) {
          return this._getEditAllowed(booking) && !this._isNewBooking(booking);
        }

        _isNewBooking(booking) {
          if (booking) {
            return !this._idsToBookings.has(booking.id);
          }
          return true;
        }

        _getDialogCaption(booking) {
          return !booking
            ? ''
            : !this._idsToBookings.has(booking.id)
              ? 'New Booking'
              : this._editAllowed
                ? 'Edit Booking'
                : 'View Booking';
        }

        _getServiceParams(resource) {
          return {'resource': resource}
        }

        _resourceIdChanged(newValue, ignored) {
          if (newValue) {
            this.$.resourceData.load()
              .then(function (resource) {
                this.set('_resource', resource);
              }.bind(this));
          }
        }

        _resourceChanged(newValue, ignored) {
          if (newValue) {
            this.$.bookingsData.load()
              .then(function (bookings) {
                this._prepareCalendarEvents(bookings);
              }.bind(this));
          }
        }

        _eventClicked(event) {
          this._booking = this._initNewBooking(event.detail.calEvent);
          this.$.editBookingDialog.open();
        }

        _eventCreated(event) {
          this._booking = this._initNewBooking(event.detail.calEvent);
          this.$.editBookingDialog.open();
        }

        _eventResized(event) {
          // update booking
        }

        _canResizeEvent(event) {
          return false;
        }

        // CRUD

        _save() {
          let eventStart = this.$.eventStartPicker.valueAsDate;
          let eventEnd = this.$.eventEndPicker.valueAsDate;

          if (!eventStart || !eventEnd || eventEnd <= eventStart) {
            this.$.wrongBookingRange.show();
            return;
          }

          this.$.editBookingDialog.close();

          this._booking.start = eventStart;
          this._booking.end = eventEnd;

          let fakeId = this._booking.id;

          this._idsToBookings.set(fakeId, this._booking);
          this.$.eventCalendar.updateEvent(this._booking);

          this.app.commitEntity('booking$Booking', this._getBookingToPersist(this._booking))
            .then(function (committed) {
              this._fakeToRealIds.set(fakeId, committed.id);
            }.bind(this));

          this._booking = null;
        }

        _delete() {
          this.$.editBookingDialog.close();

          let fakeId = this._booking.id;
          let realId = this._fakeToRealIds.get(fakeId);

          this.$.eventCalendar.removeEvent(fakeId);
          this._fakeToRealIds.delete(fakeId);
          this._idsToBookings.delete(fakeId);

          this.app.deleteEntity('booking$Booking', realId);

          this._booking = null;
        }

        _cancel() {
          this.$.editBookingDialog.close();

          if (!this._idsToBookings.has(this._booking.id)) {
            this.$.eventCalendar.removeEvent(this._booking.id);
          }

          this._booking = null;
        }

        // Utils

        _prepareCalendarEvents(bookings) {
          let idsToBookings = new Map();
          let ids = new Map();

          for (let i = 0; i < bookings.length; i++) {
            let booking = bookings[i];
            let id = this._generateId();
            ids.set(id, booking.id);
            booking.id = id;

            idsToBookings.set(id, booking);
          }

          this._idsToBookings = idsToBookings;
          this._fakeToRealIds = ids;
        }

        _getBookingToPersist(booking) {
          let bookingToPersist = Object.assign({}, booking);

          bookingToPersist.id = this._fakeToRealIds.get(booking.id);
          bookingToPersist.start = this._formatDate(bookingToPersist.start);
          bookingToPersist.end = this._formatDate(bookingToPersist.end);

          return bookingToPersist;
        }

        _initNewBooking(booking) {
          return Object.assign({
            resource: this._resource,
            owner: this._loggedUser
          }, booking);
        }

        _formatDate(date) {
          if (date) {
            let formatted = new Date(date);

            let timezoneCorrection = new Date().getTimezoneOffset() / -60;
            formatted.setHours(formatted.getHours() + timezoneCorrection);

            return formatted.toISOString()
              .replace('T', ' ')
              .replace('Z', '');
          }
          return date;
        }

        _generateId() {
          return Math.round(0.5 + Math.random() * 10000);
        }

        _getBookings(bookingsMap) {
          if (bookingsMap) {
            return Array.from(bookingsMap.values());
          }
          return [];
        }
      }

      customElements.define(BookingCalendarView.is, BookingCalendarView);
    }
  </script>
</dom-module>