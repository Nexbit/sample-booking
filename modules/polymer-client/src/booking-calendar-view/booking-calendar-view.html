<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/cuba-data/cuba-entity.html">
<link rel="import" href="../../bower_components/cuba-data/cuba-service.html">
<link rel="import" href="../booking-events-calendar/booking-events-calendar.html">
<link rel="import" href="../booking-edit-dialog/booking-edit-dialog.html">
<link rel="import" href="../shared-styles.html">

<dom-module id="booking-calendar-view">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }

      booking-events-calendar {
        height: 32em;
      }

      h3 {
        opacity: 0.7;
      }
    </style>

    <cuba-entity id="resourceData"
                 entity-name="booking$Resource"
                 entity-id="[[_resourceId]]"
                 view="resource-view"
                 auto="false"
                 data="{{_resource}}">
    </cuba-entity>

    <cuba-service id="bookingsData"
                  service-name="booking_BookingsLoadService"
                  method="load"
                  auto="false"
                  params="[[_getServiceParams(_resource)]]">
    </cuba-service>

    <h3>[[_resource.name]]</h3>

    <booking-events-calendar id="eventCalendar"
                             events="[[_getBookings(_idsToBookings)]]">
    </booking-events-calendar>

    <booking-edit-dialog id="editDialog"></booking-edit-dialog>
  </template>
  <script>
    {
      class BookingCalendarView extends Polymer.mixinBehaviors([CubaLocalizeBehavior], Polymer.Element) {
        static get is() {
          return 'booking-calendar-view';
        }

        static get properties() {
          return {
            _resourceId: {
              type: String,
              computed: '_getResourceId(route)',
              observer: '_resourceIdChanged'
            },

            _resource: {
              type: Object,
              observer: '_resourceChanged',
              value: function () {
                return null;
              }
            },

            // fake id -> booking entity
            _idsToBookings: {
              type: Object
            },

            _fakeToRealIds: {
              type: Object
            },

            _loggedUser: {
              type: Object,
              value: function () {
                return null;
              }
            },
          }
        }

        ready() {
          super.ready();

          this.app.getUserInfo().then(function (userInfo) {
            this._loggedUser = userInfo;
          }.bind(this));

          this._setupCalendar();
          this._setupEditDialog();
        }

        _setupCalendar() {
          this.$.eventCalendar.addEventListener('event-click', event => this.$.editDialog.edit(this._initBooking(event.detail.calEvent)));
          this.$.eventCalendar.addEventListener('event-created', event => this.$.editDialog.edit(this._initBooking(event.detail.calEvent)));
          this.$.eventCalendar.addEventListener('event-resized', event => this._eventResized(event));

          this.$.eventCalendar.isEventResizable = (calEvent) => this._canResizeEvent(calEvent);
          this.$.eventCalendar.isLegalEvent = (calEvent) => calEvent.start >= new Date();
        }

        _setupEditDialog() {
          this.$.editDialog.addEventListener('booking-delete', event => this._handleBookingDelete(event));
          this.$.editDialog.addEventListener('booking-cancel', event => this._handleBookingCancel(event));
          this.$.editDialog.addEventListener('booking-save', event => this._handleBookingSave(event));

          this.$.editDialog.bookingIdProvider = (fakeId) => this._fakeToRealIds.get(fakeId);
        }

        _getResourceId(route) {
          if (route && route.prefix && route.prefix.includes('booking-calendar-view')) {
            return route.path.substring(1);
          }
          return '';
        }

        _getServiceParams(resource) {
          return {'resource': resource}
        }

        _resourceIdChanged(newValue, ignored) {
          if (newValue) {
            this.$.resourceData.load()
              .then(function (resource) {
                this._resource = resource;
              }.bind(this));
          }
        }

        _resourceChanged(newValue, ignored) {
          if (newValue) {
            this.$.bookingsData.load()
              .then(function (bookings) {
                this._prepareCalendarEvents(bookings);
              }.bind(this));
          }
        }

        _eventResized(event) {
          // update booking
        }

        _canResizeEvent(event) {
          return false;
        }

        // CRUD

        _handleBookingSave(event) {
          let booking = event.detail.booking;
          this._fakeToRealIds.set(booking.id, event.detail.realId);
          this._idsToBookings.set(booking.id, booking);
          this.$.eventCalendar.updateEvent(booking);
        }

        _handleBookingDelete(event) {
          let fakeId = event.detail;
          this._fakeToRealIds.delete(fakeId);
          this._idsToBookings.delete(fakeId);
          this.$.eventCalendar.removeEvent(fakeId);
        }

        _handleBookingCancel(event) {
          let booking = event.detail;
          if (!this._idsToBookings.has(booking.id)) {
            this.$.eventCalendar.removeEvent(booking.id);
          }
        }

        // Utils

        _prepareCalendarEvents(bookings) {
          let idsToBookings = new Map();
          let ids = new Map();

          for (let i = 0; i < bookings.length; i++) {
            let booking = bookings[i];

            let realId = booking.id;
            let fakeId = Math.round(0.5 + Math.random() * 10000);
            booking.id = fakeId;

            ids.set(fakeId, realId);
            idsToBookings.set(fakeId, booking);
          }

          this._idsToBookings = idsToBookings;
          this._fakeToRealIds = ids;
        }

        _initBooking(booking) {
          return Object.assign({
            resource: this._resource,
            owner: this._loggedUser
          }, booking);
        }

        _getBookings(bookingsMap) {
          if (bookingsMap) {
            return Array.from(bookingsMap.values());
          }
          return [];
        }
      }

      customElements.define(BookingCalendarView.is, BookingCalendarView);
    }
  </script>
</dom-module>